<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>CRUD Data Diabetes Melitus</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #f4f4f4;
        }

        input {
            margin: 4px;
            padding: 6px;
        }

        button {
            padding: 6px 10px;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <h2>CRUD Data Penderita Diabetes Melitus</h2>

    <!-- FORM -->
    <form id="formData">
        <input type="hidden" id="id">

        <input type="number" id="kode_provinsi" placeholder="Kode Provinsi" required>
        <input type="text" id="nama_provinsi" placeholder="Nama Provinsi" required>
        <input type="number" id="kode_kabupaten_kota" placeholder="Kode Kab/Kota" required>
        <input type="text" id="nama_kabupaten_kota" placeholder="Nama Kab/Kota" required>
        <input type="number" id="jumlah_penderita_dm" placeholder="Jumlah DM" required>
        <input type="text" id="satuan" placeholder="Satuan" required>
        <input type="number" id="tahun" placeholder="Tahun" required>

        <button type="submit" id="submitBtn">Tambah Data</button>
        <button type="button" onclick="resetForm()">Batal</button>
    </form>

    <!-- TABEL -->
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Kode Provinsi</th>
                <th>Nama Provinsi</th>
                <th>Kode Kab/Kota</th>
                <th>Nama Kab/Kota</th>
                <th>Jumlah DM</th>
                <th>Satuan</th>
                <th>Tahun</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
            {% for d in data %}
            <tr>
                <td>{{ d.id }}</td>
                <td>{{ d.kode_provinsi }}</td>
                <td>{{ d.nama_provinsi }}</td>
                <td>{{ d.kode_kabupaten_kota }}</td>
                <td>{{ d.nama_kabupaten_kota }}</td>
                <td>{{ d.jumlah_penderita_dm }}</td>
                <td>{{ d.satuan }}</td>
                <td>{{ d.tahun }}</td>
                <td>
                    <button onclick='editData({{ d | tojson }})'>Edit</button>
                    <button onclick="hapusData({{ d.id }})">Hapus</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <h3>Grafik Jumlah Penderita Diabetes Melitus</h3>
    <img src="/grafik" alt="Grafik DM" style="width:100%; max-width:900px;">


    <script>
        let modeEdit = false;

        // SUBMIT (CREATE / UPDATE)
        document.getElementById("formData").addEventListener("submit", function (e) {
            e.preventDefault();

            const id = document.getElementById("id").value;

            const data = {
                kode_provinsi: kode_provinsi.value,
                nama_provinsi: nama_provinsi.value,
                kode_kabupaten_kota: kode_kabupaten_kota.value,
                nama_kabupaten_kota: nama_kabupaten_kota.value,
                jumlah_penderita_dm: jumlah_penderita_dm.value,
                satuan: satuan.value,
                tahun: tahun.value
            };

            if (modeEdit) {
                // UPDATE
                fetch(`/kab/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                })
                    .then(res => res.json())
                    .then(() => location.reload());
            } else {
                // CREATE
                fetch("/kab", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                })
                    .then(res => res.json())
                    .then(() => location.reload());
            }
        });

        // EDIT
        function editData(d) {
            modeEdit = true;

            document.getElementById("id").value = d.id;
            kode_provinsi.value = d.kode_provinsi;
            nama_provinsi.value = d.nama_provinsi;
            kode_kabupaten_kota.value = d.kode_kabupaten_kota;
            nama_kabupaten_kota.value = d.nama_kabupaten_kota;
            jumlah_penderita_dm.value = d.jumlah_penderita_dm;
            satuan.value = d.satuan;
            tahun.value = d.tahun;

            document.getElementById("submitBtn").innerText = "Update Data";
        }

        // DELETE
        function hapusData(id) {
            if (!confirm("Yakin hapus data ini?")) return;

            fetch(`/kab/${id}`, { method: "DELETE" })
                .then(res => res.json())
                .then(() => location.reload());
        }

        // RESET FORM
        function resetForm() {
            modeEdit = false;
            document.getElementById("formData").reset();
            document.getElementById("id").value = "";
            document.getElementById("submitBtn").innerText = "Tambah Data";
        }
    </script>

</body>

</html>